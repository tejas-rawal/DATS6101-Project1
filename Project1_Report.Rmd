---
title: "Project writeup"
author: "Emily"
date: "2022-10-29"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


output: html_document: code_folding: hide number_sections: false toc:
yes toc_depth: 3 toc_float: yes pdf_document: toc: yes toc_depth: '3'
---

```{r init, include=FALSE}
knitr::opts_chunk$set(warning = F, results = "hide", message = F)
options(scientific=T, digits = 3) 

#loading packages 
library(ggplot2)
library(ezids)
library(dplyr)
library(tibble)
library(gridExtra)
```

## Emily's starter Code

```{r, results="asis"}
#loading data 

NYweath <- data.frame(read.csv("data/NYC_weather_1869_2022.csv"))
#xkablesummary(NYweath)
JFKweath <- data.frame(read.csv("data/JFK_weather_1949-2022.csv"))
#xkablesummary(JFKweath)

```

```{r, results="asis"}
#loading packages and data 

NYweath <- data.frame(read.csv("data/NYC_weather_1869_2022.csv"))
#xkablesummary(NYweath)
#str(NYweath)                      
#cablehead(NYweath, n=5)
#tail(NYweath, n=2)
#nrow(NYweath)

```

```{r, r = "as is"}
#converting to R date format and adding columns for day, month, and year
NYweath$DATE <- as.Date(NYweath$DATE)
NYweath$day <- format(NYweath$DATE, format="%d")
NYweath$month <- format(NYweath$DATE, format="%m")
NYweath$year <- format(NYweath$DATE, format="%Y")

#converting temperature observations to numerics
NYweath$TMAX <- as.numeric(NYweath$TMAX)
NYweath$TMIN <- as.numeric(NYweath$TMIN)
NYweath$TAVG <- as.numeric(NYweath$TAVG)
NYweath$year <- as.numeric(NYweath$year)

#Making month a factor
NYweath$month <- as.factor(NYweath$month)

#creating a subset of the weather data that are only date- and temperature-related
NYweath_sub <- subset(NYweath, select = c(DATE, day, month, year, TMAX, TMIN, TAVG, PRCP, SNOW)) 

#creating a subset for 1900 on
NYweath_00 <- subset (NYweath_sub, year > 1899) # subsetting to 20th century and later
xkabledplyhead(NYweath_00)

#creating a subset for 1948 on for comparison with JFK data
NYweath_48 <- subset (NYweath_sub, year > 1947)

#now, same for JFK data  

#converting to R date format and adding columns for day, month, and year  
JFKweath$DATE <- as.Date(JFKweath$DATE)
JFKweath$day <- format(JFKweath$DATE, format="%d")
JFKweath$month <- format(JFKweath$DATE, format="%m")
JFKweath$year <- format(JFKweath$DATE, format="%Y")

#converting temperature observations to numerics
JFKweath$TMAX <- as.numeric(JFKweath$TMAX)
JFKweath$TMIN <- as.numeric(JFKweath$TMIN)
JFKweath$TAVG <- as.numeric(JFKweath$TAVG)
JFKweath$year <- as.numeric(JFKweath$year)

#Making month a factor
JFKweath$month <- as.factor(JFKweath$month)

#creating a subset of the weather data that are only date- and temperature-related
JFKweath_sub <- subset(JFKweath, select = c(DATE, day, month, year, TMAX, TMIN, TAVG, PRCP, SNOW)) 
xkablesummary(JFKweath_sub)
```

``` {r}

# Creating columns for MONTHLY averages of TMAX, TMIN, PRCP, and
# SNOW. Adding columns for MONTHLY totals of PRCP and SNOW. 

month_tmax_avg <- aggregate(TMAX ~ month + year, NYweath, mean)
month_tmin_avg <- aggregate(TMIN ~ month + year, NYweath, mean)

month_precip_avg <- aggregate(PRCP ~ month + year, NYweath, mean)
colnames(month_precip_avg)[3] <- "PRCP_AVG"

month_precip_total <- aggregate(PRCP ~ month + year, NYweath, sum)
colnames(month_precip_total)[3] <- "PRCP_TOT"

month_snow_avg <- aggregate(SNOW ~ month + year, NYweath, mean)
colnames(month_snow_avg)[3] <- "SNOW_AVG"

month_snow_total <- aggregate(SNOW ~ month + year, NYweath, sum)
colnames(month_snow_total)[3] <- "SNOT_TOT"


monthly_weather <- data.frame(month_tmax_avg, 
                              month_tmin_avg$TMIN,
                              month_precip_avg$PRCP_AVG,
                              month_precip_total$PRCP_TOT,
                              month_snow_avg$SNOW_AVG,
                              month_snow_total$SNOT_TOT)
colnames(monthly_weather)[4:8] <- c("TMIN", "PRCP_AVG", "PRCP_TOT", "SNOW_AVG", "SNOW_TOT")

monthly_weather_100yr <- subset(monthly_weather, monthly_weather$year > 1899 & monthly_weather$year < 2022)


```

``` {r}

# Doing the same for YEARLY data
# Creating columns for YEARLY averages of TMAX, TMIN, PRCP, and
# SNOW. Adding columns for YEARLY totals of PRCP and SNOW. 

year_tmax_avg <- aggregate(TMAX ~ year, NYweath, mean)
year_tmin_avg <- aggregate(TMIN ~ year, NYweath, mean)

year_precip_avg <- aggregate(PRCP ~ year, NYweath, mean)
colnames(year_precip_avg)[2] <- "PRCP_AVG"

year_precip_total <- aggregate(PRCP ~ year, NYweath, sum)
colnames(year_precip_total)[2] <- "PRCP_TOT"

year_snow_avg <- aggregate(SNOW ~ year, NYweath, mean)
colnames(year_snow_avg)[2] <- "SNOW_AVG"

year_snow_total <- aggregate(SNOW ~ year, NYweath, sum)
colnames(year_snow_total)[2] <- "SNOT_TOT"


yearly_weather <- data.frame(year_tmax_avg, 
                             year_tmin_avg$TMIN, 
                             year_precip_avg$PRCP_AVG, 
                             year_precip_total$PRCP_TOT, 
                             year_snow_avg$SNOW_AVG, 
                             year_snow_total$SNOT_TOT)
colnames(yearly_weather)[3:7] <- c("TMIN", "PRCP_AVG", "PRCP_TOT", "SNOW_AVG", "SNOW_TOT")


yearly_weather_100yr <- subset(yearly_weather, yearly_weather$year > 1899 & yearly_weather$year < 2022)


```


As scientists, our team is curious about how humans can affect the
natural environment. We wondered if weather conditions in a highly
populated region might correlate with notable human activities on a
global or local scale.

There is a variety of literature available on global climate change,
suggesting that the Earth's surface temperature is increasing, on
average, over time in a way that threatens many lifeforms on our planet.
This warming is primarily due to human activity: the combustion of
fossil fuels resulting in the emission of carbon dioxide into the
atmosphere. We decided to consider local weather trends in a specific
urban area to see what we might learn.

After some search, we discovered that historical daily weather records
from locations around the United States are made publicly availably by
the National Oceanic and Atmospheric Administrative via their website:
<https://www.ncdc.noaa.gov/cdo-web>. We found that a data station in the
middle of Central Park in New York City has made more than 56,000 daily
weather observations dating back to 1869. The variables observed
included daily maximum temperature in degrees Fahrenheit (TMAX), daily
minimum temperature in degrees Fahrenheit (TMIN), and daily precipitation (PRCP) and snowfall (SNOW) in inches. We decided to analyze
these data to see what trends we might uncover. Our data span the days
from February 28, 1869, to September 26, 2022.

Temperature data from Central Park have been studied in the past, and
warming trends were observed; we wanted to see what we might discover on
our own, from analysis of the original data.

## Our Research Questions

Given that Central Park is an oasis in the middle of a city environment,
we wondered whether any weather trends correlate with major human
activities-- both globally and locally. To explore these possibilities,
we formulated the following preliminary questions:

1.  Are there statistically measurable changes in weather patterns
    (e.g., temperature and precipitation levels) over time in New York
    City?\
2.  Do temperature trends in New York City align with the documented
    rise in average global temperatures over the last century?\
3.  Are there any notable (and statistically significant) changes in
    weather patterns after/during the pandemic lockdown (perhaps due to
    changes in commuting patterns)?

To dig in, we began with temperature.

## Temperature - stat tests of temp trends over time  

We started by understanding the distributions of our temperature data to rule out any anomalies or peculiar characteristics. Another aspect of our data that we could potentially account for is seasonality, as temperatures ranges differ between summer and winter months.  

```{r temperature distributions, results='asis'}
mean_tmax <- mean(NYweath_00$TMAX)
mean_tmin <- mean(NYweath_00$TMIN)

ggplot(NYweath_00) +
  geom_histogram(aes(x=TMAX, fill="Max Temp."), na.rm=TRUE, alpha=0.5, color="black", bins=100, binwidth=2) +
  geom_vline(xintercept=mean_tmax, color="red", size=1, linetype=5, show.legend=FALSE) +
  annotate("text", x=mean_tmax + 9, y=2000, label=paste(round(mean_tmax, 2), "°F"), angle=0, size=4, color="darkred") +
  geom_histogram(aes(x=TMIN, fill="Min Temp."), na.rm=TRUE, alpha=0.5, color="black", bins=100, binwidth=2) +
  geom_vline(xintercept=mean_tmin, color="blue", size=1, linetype=5, show.legend=FALSE) +
  annotate("text", x=mean_tmin - 9, y=2000, label=paste(round(mean_tmin, 2), "°F"), angle=0, size=4, color="darkblue") +
  labs(title="Distribution of Minimum and Maximum Daily Temperatures", x="Temperature (°F)", y="Count") +
  scale_y_continuous(position = "right") +
  scale_fill_manual(name="Column", values=c("Max Temp."="red","Min Temp."="blue"))
```

The distributions of both TMAX and TMIN do not appear to be normal at first glance, with TMAX being slightly skewed to the left and TMIN having two peaks. The average daily maximum temperature is `r paste(round(mean_tmax, 2), "°F")`, and the average daily minimum temperature is `r paste(round(mean_tmin, 2), "°F")`. As expected, the distribution of TMAX includes temperature observations that are greater that those of TMIN, with a significant overlap. That overlap can be attributed to seasonality within the data. Because we have a large number of observations, we can assume normality for the sake of our statistical testing moving forward.  

```{r month average bar plot, results='asis'}
NYweath_Month <- NYweath_00 %>%
  group_by(month) %>%
  summarize("Avg Max Temp." = mean(TMAX, na.rm=T),
            "Avg Min Temp." = mean(TMIN, na.rm=T))

# side-by-side bar plot
NYweath_Month %>%
  dplyr::select(month, "Avg Max Temp.", "Avg Min Temp.") %>%
  gather(key="Value", value="Temp.", "Avg Max Temp.", "Avg Min Temp.") %>%
  ggplot(aes(x=month, y=Temp., fill=Value)) +
  geom_col(na.rm=TRUE, alpha=0.5, color="black", position="dodge") +
  labs(title="Average Daily Temperature By Month", x="Month", y="Average Temperature (°F)") +
  scale_fill_manual(values=c("red", "blue"))
```

The understand the effect of seasonality on the temperature data, we calculated the average daily temperatures by month. As we can see here, there is a trend of rising temperatures when we move from winter to summer months. This is to be expected since summer will have higher average daily maximum and minimum temperatures than winter.  

Now that we have insight into the distribution of our variables, it was time to start assessing whether the data confirmed any significant changes in daily temperatures over the time. Specifically, we want to test whether changes in average daily maximum temperatures coincide with the documented rise in global temperatures over the last century. A report on the global change in Earth's temperature and climate is available via the National Oceanic And Atmospheric Administration <https://www.ncdc.noaa.gov/sotc/global/202113>.  

We grouped the daily temperature observations into 3 distinct eras in American history. The eras are described as:  
  1. Industrial Era: 1900-1940  
  2. Cold War Era: 1940-1980  
  3. Modern Era: 1980-Present (2022)  
  
This distinction was important because we could now compare temperature observations across three different and unique samples. Each era contains roughly 15,000 daily observations which is an important factor in the analysis we will perform next.  
 
```{r era distributions}
industrial_era <- NYweath_00 %>%
  dplyr::select(-month) %>%
  filter(year >= 1900, year < 1940)

coldwar_era <- NYweath_00 %>%
  dplyr::select(-month) %>%
  filter(year >= 1940, year < 1980)

modern_era <- NYweath_00 %>%
  dplyr::select(-month) %>%
  filter(year >= 1980)
```


```{r era box plots, results='asis'}
# modify data set by adding ERA column
industrial_era <- industrial_era %>%
  mutate(Era = 1)
coldwar_era <- coldwar_era %>%
  mutate(Era = 2)
modern_era <- modern_era %>%
  mutate(Era = 3)
# combine data frames
all_eras <- rbind(industrial_era, coldwar_era, modern_era)
# convert ERA column to factor/categorical
all_eras$Era <- factor(all_eras$Era, labels = c("Indst.", "Cold War", "Modern"))

# box plot
means <- aggregate(TMAX ~ Era, all_eras, mean)

all_eras %>%
  ggplot(aes(x=Era, y=TMAX, fill=Era)) +
  geom_boxplot(na.rm=TRUE, alpha=0.7, color="black") +
  stat_summary_bin(fun="mean", geom="point", shape=20, size=5, show.legend=FALSE) +
  geom_text(data = means, aes(label=round(TMAX, 2) , y=TMAX - 5)) +
  labs(title="Distribution of Daily Maximum Temperature By Era", x="Era", y="Temperature (°F)") +
  scale_fill_brewer(palette="Dark2")
```

The distributions of each era look similar, however the calculated average daily maximum temperatures between each era did indicate a slight difference. To test the statistical significance of these differences, we ran an ANOVA test comparing the three eras.

```{r anova and tukey, results='asis'}
# run ANOVA
anova_res <- aov(TMAX ~ Era, data = all_eras)
xkabledply(anova_res)
```

With a p-value much lower than our threshold of 0.05, we have verified that the statistical differences between the average daily maximum temperature of the 3 eras is significant. That's good news, but just how difference are they from each other? For that answer, we can turn to Tukey's HSD (honestly significant difference) test. This test helps us compare the differences between all possible pairs of eras and evaluate their significance.  

```{r tukey test, results='asis'}
tukeyAoV <- TukeyHSD(anova_res, conf.level=0.95)
plot(tukeyAoV, col="red", cex.axis=0.75)
```
The test results confirm that the difference in average daily maximum temperature between each pair of eras is significantly difference. The plot helps highlights these differences.  

Through our analysis of the observations between the three eras, we are able to safely reject the hypothesis that the average daily maximum temperature remains the same. There is significant evidence to suggest that our TMAX variable is increasing over time.  

## Chris's linear model  - blurb  

## Emily's linear model Linear Models of Temperature over Time

We then created a linear model of TMAX vs. year to understand the temperature trends since 1900. The fit parameters were statistically significant, and suggested that both the maximum and minimum daily temperatures in New York's Central Park have increased on average over time at a rate of approximately 0.026 degrees per year. While the p-value for this parameter is < 2e-16 (well below the threshold of alpha = 0.05), this overall fit is poor, with an adjusted r-squared value of 0.00245.  


```{r}
# Linear regression of TMAX \~ year from 1900 on.
maxTfit00_0 <- lm(formula = TMAX ~ year, data = NYweath_00 )
summary(maxTfit00_0)  
```

The poor fit is likely due to the wide range of daily temperatures that occur in a given year as a result of seasonal variation. The following plot of daily maximum temperatures shows the wide variance of the data around the linear model. 

```{r}
ggplot(NYweath_00, aes(x = DATE, y = TMAX, color = month)) + 
    geom_point(alpha = 0.6) +
    scale_color_manual(values = c("01" = "purple4",
                                  "02" = "purple",
                                  "03" = "dodgerblue",
                                  "04" = "cyan4",
                                  "05" = "yellow",
                                  "06" = "darkgoldenrod1",
                                  "07" = "red",
                                  "08" = "orange", 
                                  "09" = "yellow",
                                  "10" = "green",
                                  "11" = "turquoise",
                                  "12" = "steelblue")) +
      labs(
        x = "Year",
        y = "Maximum Daily Temperature",
        title = "Maximum Daily Temperature in Central Park") +
    xlab(label = "Year") +
    ylab(label = "Maximum daily temperature") +
    ggtitle(label = "Maximum Daily Temperature in Central Park") +
    stat_smooth(method = "lm",
            formula = y ~ x,
            geom = "smooth",
            color = "black",
            show.legend = F)  
```


## Linear regression of TMAX \~ year + month from 1900 on.

```{r}
# Linear regression of TMAX \~ year from 1900 on.
maxTfit00_0 <- lm(formula = TMIN ~ year, data = NYweath_00 )
summary(maxTfit00_0)  
```

In order to improve the fit and model temperature trends more completely, we decided to account for seasonal variation by also including month as a categorical regressor. The resulting fit has an r-squared value of 0.775 and a slope of 0.025 degrees Fahreinheit per year, with all fit parameters' p-values well below 0.05. The different intercepts for the each level of the categorical variable (the twelve months of the year) indicate that January is the coldest and July the hottest month in Central Park, with an average difference in maximum daily temperature of approximately 46 degrees Fahrenheit in any given year over this window.  


```{r}
maxTfit00_1 <- lm(formula = TMAX ~ year + month, data = NYweath_00 )
summary(maxTfit00_1)  

```

These two extremes and their linear models are plotted in the following figure; it is clear that the multiple regression is a much better model of temperature trends, consistent with the higher r-squared value.  


```{r}
ggplot(NYweath_00, aes(x = year, y = TMAX, color = month)) +
    geom_point() +
    scale_color_manual(values = c("01" = "purple4",
                                   "07" = "red"), na.value = NA) +
    geom_abline(aes(intercept = -11.05508, slope = 0.02539), col = "black", size = 1) + 
    geom_abline(aes(intercept = 34.98295, slope = 0.02539), col = "black", size = 1) +
  
    labs(
        x = "Year",
        y = "Maximum Daily Temperature",
        title = "Maximum Daily Temperature in Central Park") +
    xlab(label = "Year") +
    ylab(label = "Maximum daily temperature") +
    ggtitle(label = "Maximum Daily Temperature in Central Park")  
#    stat_smooth(method = "lm",
#            formula = y ~ x,
#            geom = "smooth",
#            color = "black",
#            show.legend = F)
```

To create an even better model, we'd need to use sinusoidal functions that capture the cyclical variation of weather with season.  

## Central Park v. Global average - Chris  

## JFK data, comparable?  - Emily  

We wondered whether these trends were true for other locations in the New York City area. To assess this, we found data from another NOAA station at JFK International Airport. Because these data date only as far back as the Airport (which was built in 1948), we focused on 1948 on, computing linear models for both regions for this time window.  

We were suprised to notice that the slope of the Central Park model for 1948 on was lower than that including observations from 1900 on; only 0.014 degrees per year compared to 0.025. This suggests that average Central Park warming was greater in the first half of the 20th century than in the second half-- which is not what we would intuit based on the understanding that the global rate of warming is increasing.  

We also found a higher warming rate at the JFK airport site, of approximately 0.033 degrees Fahrenheit per year.  

How did thinking change? reframing of questioning?  
Additional data to test our hypothesis of causality  

## Precipitation trends -Tejas' outlier analysis + snowfall at Christmas

## Linear models of precipitation trends over time - Chris

After seeing the greater variability in precipitation more recently, we plotted total precipitation and total snowfall and fit these variables to linear models to observe the trends over time (Figure C3).

```{r}

# PRCP linear models and plots
yearly_prcp_scatter <- ggplot(yearly_weather_100yr, aes(x = year, y = PRCP_TOT)) + 
  geom_point(color = "darkorchid") +
  labs(x = "Year", y = "Total Precipitation (in)", title = "Total Yearly Precipitation")      


lm_prcp_yr <- lm(PRCP_TOT ~ year, data = yearly_weather_100yr)



yearly_snow_scatter <- ggplot(yearly_weather_100yr, aes(x = year, y = SNOW_TOT)) + 
  geom_point(color = "azure4") +
  labs(x = "Year", y = "Total Snowfall (in)", title = "Total Yearly Snowfall")

lm_snow_yr <- lm(SNOW_TOT ~ year, data = yearly_weather_100yr)
summary(lm_snow_yr)


yr_prcp_scatter_line <- yearly_prcp_scatter+
  stat_smooth(method = "lm",
              formula = y ~ x,
              geom = "smooth",
              color = "black",
              show.legend = F) + 
  labs(title = "Total Yearly Precipitation")


yr_snow_scatter_line <- yearly_snow_scatter+
  stat_smooth(method = "lm",
              formula = y ~ x,
              geom = "smooth",
              color = "black",
              show.legend = F)+
  labs(title = "Total Yearly Snowfall") 


grid.arrange(yr_prcp_scatter_line, yr_snow_scatter_line,
             nrow = 1, 
             top = "Figure C3: Weather Patterns in Central Park, NYC, from 1900-2021")


```
There is no clear trend in the linear model fit in total yearly Central Park precipitation since 1900. The model has a very weak correlation over time, increasing at a rate of 0.75 inches per decade. However, given the poor fit to the data, this is likely a result of more higher leverage data points in more recent times that have artificially increased the overall trend. Our earlier observation of increased variability in yearly precipitation over time supports this explanation. 

For total yearly snowfall in Central Park since 1900, there was no statistically significant trend observed in the data. 

## Correlation between temp / precip -- Emily  ... think about subsequent analyses

## Lockdown - Chris

The COVID-19 lockdown had major social, economic, and political impacts in 2020. The lockdown in New York City in Spring of 2020 was one of the earliest in effect and saw unprecedented traffic and life-pattern changes to those who visited and worked in NYC daily.

An analysis was performed to determine if these changes had any affects on the local weather for the city. To do this, the average daily maximum temperatures for spring (considered April and May) and summer (considered June, July and August) were compared using the years leading up to the pandemic and the months following the lockdown order (Figure C4). 


```{r}
# Generating a lock down box plot
covid_spring_summer <- subset(NYweath,
                           year > 2010 &
                           year <= 2020 &
                          (month == "04" |month == "05" | 
                             month == "06" | month == "07" | 
                             month == "08"))
covid_spring_summer_ld <- covid_spring_summer %>%
  add_column(Lockdown = 
               ifelse(.$year < 2020, "Pre-Lockdown", "Post-Lockdown"),
             .after = "year")
covid_spring_summer_ld$Lockdown <- factor(covid_spring_summer_ld$Lockdown, levels = c('Pre-Lockdown', 'Post-Lockdown'))

covid_ld_season <- covid_spring_summer_ld %>%
  add_column(Season = 
               ifelse(.$month == "04" | .$month == "05", 
                      "Spring", "Summer"),
             .after = "year")

covid_boxplot <- ggplot()+
  geom_boxplot(data = covid_ld_season, aes(y = TMAX, x = Season, fill = Lockdown)) +
  labs(title = " Figure C4: Temperature Ranges Pre- and Post- COVID Lockdown")

covid_boxplot



```

```{r}

# performing pre- and post- lock down t test
pre_spring <- subset(NYweath,
                           year > 2010 & year < 2020 &
                           (month == "04" |month == "05"))


pre_summer <- subset(NYweath,
                           year > 2010 & year < 2020 &
                           (month == "06" |month == "07" |
                            month == "08"))


covid_lockdown_spring <- subset(NYweath,
                           year == 2020 &
                           (month == "04" |month == "05"))


covid_lockdown_summer <- subset(NYweath,
                           year == 2020 &
                           (month == "06" |month == "07" |
                            month == "08"))

library(reshape2)

cov_spring_ttest <- t.test(pre_spring$TMAX, covid_lockdown_spring$TMAX)
cov_spring_ttest

cov_summer_ttest <- t.test(pre_summer$TMAX, covid_lockdown_summer$TMAX)
cov_summer_ttest
cov_spring_ttest$conf.int

t.test(pre_spring$TMAX)
t.test(covid_lockdown_spring$TMAX)


```

A t-test was performed to compare the means of the pre-lockdown and post-lockdown maximum daily temperatures (Table C2). For the summer lockdown months, the summer following lockdown appeared to be warmer on average. However, this was not a statistically significant difference in the average maximum temperatures.

The spring lockdown months showed a statistically significant difference in the means pre- and post- lockdown order.The post-lockdown months were significantly cooler than the years preceding the COVID-19 pandemic. 



## Conclusion- terse summary of findings, restate new questions from all sections, ideas for future analyses if you give us more money.    

If we have time, summarize what we learned from each variable, and new questions?

