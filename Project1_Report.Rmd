---
title: "Project writeup"
author: "Chris, Tejas, and Emily"
date: "`r Sys.Date()`"
output:
  html_document:
    number_sections: false
    toc: yes
    toc_depth: 3
    toc_float: yes
  pdf_document:
    toc: yes
    toc_depth: 3
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(warning = F, results = "hide", message = F, echo = F)
options(scientific=T, digits = 3) 
```

```{r init}
#loading packages 
library(ezids)
library(tidyverse)
library(ggrepel)
library(gridExtra)
library(tibble)

#loading data 

NYweath <- data.frame(read.csv("data/NYC_weather_1869_2022.csv"))
JFKweath <- data.frame(read.csv("data/JFK_weather_1949-2022.csv"))

#converting to R date format and adding columns for day, month, and year
NYweath$DATE <- as.Date(NYweath$DATE)
NYweath$day <- format(NYweath$DATE, format="%d")
NYweath$month <- format(NYweath$DATE, format="%m")
NYweath$year <- format(NYweath$DATE, format="%Y")

#converting temperature observations to numerics
NYweath$TMAX <- as.numeric(NYweath$TMAX)
NYweath$TMIN <- as.numeric(NYweath$TMIN)
NYweath$TAVG <- as.numeric(NYweath$TAVG)
NYweath$year <- as.numeric(NYweath$year)

#Making month a factor
NYweath$month <- as.factor(NYweath$month)

#creating a subset of the weather data that are only date- and temperature-related
NYweath_sub <- subset(NYweath, select = c(DATE, day, month, year, TMAX, TMIN, TAVG, PRCP, SNOW)) 

#creating a subset for 1900 on
NYweath_00 <- subset(NYweath_sub, year > 1899) # subsetting to 20th century and later
xkabledplyhead(NYweath_00)

#creating a subset for 1948 on for comparison with JFK data
NYweath_48 <- subset (NYweath_sub, year > 1947)

#now, same for JFK data  

#converting to R date format and adding columns for day, month, and year  
JFKweath$DATE <- as.Date(JFKweath$DATE)
JFKweath$day <- format(JFKweath$DATE, format="%d")
JFKweath$month <- format(JFKweath$DATE, format="%m")
JFKweath$year <- format(JFKweath$DATE, format="%Y")

#converting temperature observations to numerics
JFKweath$TMAX <- as.numeric(JFKweath$TMAX)
JFKweath$TMIN <- as.numeric(JFKweath$TMIN)
JFKweath$TAVG <- as.numeric(JFKweath$TAVG)
JFKweath$year <- as.numeric(JFKweath$year)

#Making month a factor
JFKweath$month <- as.factor(JFKweath$month)

#creating a subset of the weather data that are only date- and temperature-related
JFKweath_sub <- subset(JFKweath, select = c(DATE, day, month, year, TMAX, TMIN, TAVG, PRCP, SNOW)) 
xkablesummary(JFKweath_sub)

# Creating columns for MONTHLY averages of TMAX, TMIN, PRCP, and
# SNOW. Adding columns for MONTHLY totals of PRCP and SNOW. 

month_tmax_avg <- aggregate(TMAX ~ month + year, NYweath, mean)
month_tmin_avg <- aggregate(TMIN ~ month + year, NYweath, mean)

month_precip_avg <- aggregate(PRCP ~ month + year, NYweath, mean)
colnames(month_precip_avg)[3] <- "PRCP_AVG"

month_precip_total <- aggregate(PRCP ~ month + year, NYweath, sum)
colnames(month_precip_total)[3] <- "PRCP_TOT"

month_snow_avg <- aggregate(SNOW ~ month + year, NYweath, mean)
colnames(month_snow_avg)[3] <- "SNOW_AVG"

month_snow_total <- aggregate(SNOW ~ month + year, NYweath, sum)
colnames(month_snow_total)[3] <- "SNOT_TOT"

monthly_weather <- data.frame(month_tmax_avg, 
                              month_tmin_avg$TMIN,
                              month_precip_avg$PRCP_AVG,
                              month_precip_total$PRCP_TOT,
                              month_snow_avg$SNOW_AVG,
                              month_snow_total$SNOT_TOT)
colnames(monthly_weather)[4:8] <- c("TMIN", "PRCP_AVG", "PRCP_TOT", "SNOW_AVG", "SNOW_TOT")

monthly_weather_100yr <- subset(monthly_weather, monthly_weather$year > 1899 & monthly_weather$year < 2022)

# Doing the same for YEARLY data
# Creating columns for YEARLY averages of TMAX, TMIN, PRCP, and
# SNOW. Adding columns for YEARLY totals of PRCP and SNOW. 

year_tmax_avg <- aggregate(TMAX ~ year, NYweath, mean)
year_tmin_avg <- aggregate(TMIN ~ year, NYweath, mean)

year_precip_avg <- aggregate(PRCP ~ year, NYweath, mean)
colnames(year_precip_avg)[2] <- "PRCP_AVG"

year_precip_total <- aggregate(PRCP ~ year, NYweath, sum)
colnames(year_precip_total)[2] <- "PRCP_TOT"

year_snow_avg <- aggregate(SNOW ~ year, NYweath, mean)
colnames(year_snow_avg)[2] <- "SNOW_AVG"

year_snow_total <- aggregate(SNOW ~ year, NYweath, sum)
colnames(year_snow_total)[2] <- "SNOT_TOT"


yearly_weather <- data.frame(year_tmax_avg, 
                             year_tmin_avg$TMIN, 
                             year_precip_avg$PRCP_AVG, 
                             year_precip_total$PRCP_TOT, 
                             year_snow_avg$SNOW_AVG, 
                             year_snow_total$SNOT_TOT)
colnames(yearly_weather)[3:7] <- c("TMIN", "PRCP_AVG", "PRCP_TOT", "SNOW_AVG", "SNOW_TOT")


yearly_weather_100yr <- subset(yearly_weather, yearly_weather$year > 1899 & yearly_weather$year < 2022)
```


As a group of scientists, our team is curious about how humans can affect the
natural environment. We wondered if weather conditions in a highly
populated region might correlate with notable human activities on a
global or local scale.

There is a variety of literature available on global climate change,
suggesting that the Earth's surface temperature is increasing, on
average, over time in a way that threatens many lifeforms on our planet.
This warming is primarily due to human activity: the combustion of
fossil fuels resulting in the emission of carbon dioxide into the
atmosphere. We decided to consider local weather trends in a specific
urban area to see what we might learn.

After some search, we discovered that historical daily weather records
from locations around the United States are made publicly available by
the National Oceanic and Atmospheric Administrative via their website:
<https://www.ncdc.noaa.gov/cdo-web>. We found that a data station in the
middle of Central Park in New York City has made more than 56,000 daily
weather observations dating back to 1869. The variables observed
included daily maximum temperature in degrees Fahrenheit (TMAX), daily
minimum temperature in degrees Fahrenheit (TMIN), and daily precipitation (PRCP) and snowfall (SNOW) in inches. We decided to analyze
these data to see what trends we might uncover. Our data span the days
from February 28, 1869, to September 26, 2022.

Temperature data from Central Park have been studied in the past, and
warming trends were observed; we wanted to see what we might discover on
our own, from analysis of the original data.

## Our Research Questions

Given that Central Park is an oasis in the middle of a city environment,
we wondered whether any weather trends correlate with major human
activities-- both globally and locally. To explore these possibilities,
we formulated the following preliminary questions:

1.  Are there statistically measurable changes in weather patterns
    (e.g., temperature and precipitation levels) over time in New York
    City?\
2.  Do temperature trends in New York City align with the documented
    rise in average global temperatures over the last century?\
3.  Are there any notable (and statistically significant) changes in
    weather patterns after/during the pandemic lockdown (perhaps due to
    changes in commuting patterns)?

To dig in, we began with temperature.

## Temperature - stat tests of temp trends over time  

We started by understanding the distributions of our temperature data to rule out any anomalies or unusual characteristics.  

```{r temperature distributions, results='asis'}
mean_tmax <- mean(NYweath_00$TMAX)
mean_tmin <- mean(NYweath_00$TMIN)

ggplot(NYweath_00) +
  geom_histogram(aes(x=TMAX, fill="Max Temp."), na.rm=TRUE, alpha=0.5, color="black", bins=100, binwidth=2) +
  geom_vline(xintercept=mean_tmax, color="red", size=1, linetype=5, show.legend=FALSE) +
  annotate("text", x=mean_tmax + 9, y=2000, label=paste(round(mean_tmax, 2), "°F"), angle=0, size=4, color="darkred") +
  geom_histogram(aes(x=TMIN, fill="Min Temp."), na.rm=TRUE, alpha=0.5, color="black", bins=100, binwidth=2) +
  geom_vline(xintercept=mean_tmin, color="blue", size=1, linetype=5, show.legend=FALSE) +
  annotate("text", x=mean_tmin - 9, y=2000, label=paste(round(mean_tmin, 2), "°F"), angle=0, size=4, color="darkblue") +
  labs(title="Distribution of Minimum and Maximum Daily Temperatures", x="Temperature (°F)", y="Count") +
  scale_y_continuous(position = "right") +
  scale_fill_manual(name="Column", values=c("Max Temp."="red","Min Temp."="blue"))
```

The distributions of both TMAX and TMIN do not appear to be normal at first glance, with TMAX being slightly skewed to the left and TMIN having two peaks. As expected, the distribution of TMAX includes temperature observations that are greater than those of TMIN, with a significant overlap. That overlap can be attributed to seasonality within the data. Because we have a large number of observations, we can assume normality for the sake of our statistical testing moving forward.  

```{r month average bar plot, results='asis'}
NYweath_Month <- NYweath_00 %>%
  group_by(month) %>%
  summarize("Avg Max Temp." = mean(TMAX, na.rm=T),
            "Avg Min Temp." = mean(TMIN, na.rm=T))

# side-by-side bar plot
NYweath_Month %>%
  dplyr::select(month, "Avg Max Temp.", "Avg Min Temp.") %>%
  gather(key="Value", value="Temp.", "Avg Max Temp.", "Avg Min Temp.") %>%
  ggplot(aes(x=month, y=Temp., fill=Value)) +
  geom_col(na.rm=TRUE, alpha=0.5, color="black", position="dodge") +
  labs(title="Average Daily Temperature By Month", x="Month", y="Average Temperature (°F)") +
  scale_fill_manual(values=c("red", "blue"))
```

The understand the effect of seasonality on the temperature data, we calculated the average daily temperatures by month. As we can see here, there is a trend of rising temperatures when we move from winter to summer months. This is to be expected since summer will see higher average daily maximum and minimum temperatures than winter. Seasonality is an aspect of our data that we might need to account for in our testing, as temperatures ranges clearly differ between summer and winter months.  

Now that we have insight into the distribution of our variables, it was time to start assessing whether the data confirmed any significant changes in daily temperatures over the time. Specifically, we want to test whether changes in average daily maximum temperatures coincide with the documented rise in global temperatures over the last century. A report on the global change in Earth's temperature and climate is available via the National Oceanic And Atmospheric Administration <https://www.ncdc.noaa.gov/sotc/global/202113>.  

We grouped the daily temperature observations into 3 distinct eras in American history. The eras are described as:  
  1. **Industrial Era**: 1900-1940  
  2. **Cold War Era**: 1940-1980  
  3. **Modern Era**: 1980-Present  
  
This distinction was important because we could now compare temperature observations across three independent groups, and each era contains roughly 15,000 daily observations giving us statistically powerful sample sizes to work off of.   
 
```{r era distributions}
industrial_era <- NYweath_00 %>%
  dplyr::select(-month) %>%
  filter(year >= 1900, year < 1940)

coldwar_era <- NYweath_00 %>%
  dplyr::select(-month) %>%
  filter(year >= 1940, year < 1980)

modern_era <- NYweath_00 %>%
  dplyr::select(-month) %>%
  filter(year >= 1980)
```


```{r era box plots, results='asis'}
# modify data set by adding ERA column
industrial_era <- industrial_era %>%
  mutate(Era = 1)
coldwar_era <- coldwar_era %>%
  mutate(Era = 2)
modern_era <- modern_era %>%
  mutate(Era = 3)
# combine data frames
all_eras <- rbind(industrial_era, coldwar_era, modern_era)
# convert ERA column to factor/categorical
all_eras$Era <- factor(all_eras$Era, labels = c("Indst.", "Cold War", "Modern"))

# box plot
means <- aggregate(TMAX ~ Era, all_eras, mean)

all_eras %>%
  ggplot(aes(x=Era, y=TMAX, fill=Era)) +
  geom_boxplot(na.rm=TRUE, alpha=0.7, color="black") +
  stat_summary_bin(fun="mean", geom="point", shape=20, size=5, show.legend=FALSE) +
  geom_text(data = means, aes(label=round(TMAX, 2) , y=TMAX - 5)) +
  labs(title="Distribution of Daily Maximum Temperature By Era", x="Era", y="Temperature (°F)") +
  scale_fill_brewer(palette="Dark2")
```

The calculated average daily maximum temperature of each era suggests there's a slight difference across the time periods. To verify the statistical significance of these differences, we ran an ANOVA test comparing the three eras.  

```{r anova and tukey}
# run ANOVA
anova_res <- aov(TMAX ~ Era, data = all_eras)
xkabledply(anova_res)
```

The test netted a p-value much lower than our threshold of 0.05, verifying that the statistical differences between the average daily maximum temperature of the 3 eras is significant.  

That's good news, but just how differenty are they from each other? For that answer, we can turn to Tukey's HSD (honestly significant difference) test. This test helps us compare the differences between all possible pairs of our groupings and evaluates their significance.  

```{r tukey test, results='asis'}
tukeyAoV <- TukeyHSD(anova_res, conf.level=0.95)
plot(tukeyAoV, col="red", cex.axis=0.75)
```

The plot above displays the estimated difference between the means of each dual-era comparison along with a 95% confidence interval for that difference. The largest estimated difference in mean is between the Industrial and Modern eras. The adjusted p-value for each 2-way comparison was practically 0, indicating that the differences in the average daily maximum temperature between the eras is statistically significant.  

Through this analysis, we are able to safely reject the hypothesis that the average daily maximum temperature remains the same across each era. There is significant evidence to suggest that our TMAX variable is increasing over time. We can utilize linear regressions to dive further into this relationship.  

## Linear Models of Temperature over Time

We then created a linear model of TMAX vs. year to understand the temperature trends since 1900. The fit parameters were statistically significant, and suggested that both the maximum and minimum daily temperatures in New York's Central Park have increased on average over time at a rate of approximately 0.026 degrees per year. While the p-value for this parameter is < 2e-16 (well below the threshold of alpha = 0.05), this overall fit is poor, with an adjusted r-squared value of 0.00245.  


```{r}
# Linear regression of TMAX \~ year from 1900 on.
maxTfit00_0 <- lm(formula = TMAX ~ year, data = NYweath_00 )
summary(maxTfit00_0)  
```

The poor fit is likely due to the wide range of daily temperatures that occur in a given year as a result of seasonal variation. The following plot of daily maximum temperatures shows the wide variance of the data around the linear model.  

```{r}
ggplot(NYweath_00, aes(x = DATE, y = TMAX, color = month)) + 
    geom_point(alpha = 0.6) +
    scale_color_manual(values = c("01" = "purple4",
                                  "02" = "purple",
                                  "03" = "dodgerblue",
                                  "04" = "cyan4",
                                  "05" = "yellow",
                                  "06" = "darkgoldenrod1",
                                  "07" = "red",
                                  "08" = "orange", 
                                  "09" = "yellow",
                                  "10" = "green",
                                  "11" = "turquoise",
                                  "12" = "steelblue")) +
      labs(
        x = "Year",
        y = "Maximum Daily Temperature",
        title = "Maximum Daily Temperature in Central Park") +
    xlab(label = "Year") +
    ylab(label = "Maximum daily temperature") +
    ggtitle(label = "Maximum Daily Temperature in Central Park") +
    stat_smooth(method = "lm",
            formula = y ~ x,
            geom = "smooth",
            color = "black",
            show.legend = F)  
```


```{r}
# Linear regression of TMAX \~ year from 1900 on.
maxTfit00_0 <- lm(formula = TMIN ~ year, data = NYweath_00 )
summary(maxTfit00_0)  
```

In order to improve the fit and model temperature trends more completely, we decided to account for seasonal variation by also including month as a categorical regressor. The resulting fit has an r-squared value of 0.775 and a slope of 0.025 degrees Fahrenheit per year, with all fit parameters' p-values well below 0.05. The different intercepts for the each level of the categorical variable (the twelve months of the year) indicate that January is the coldest and July the hottest month in Central Park, with an average difference in maximum daily temperature of approximately 46 degrees Fahrenheit in any given year over this window.  


```{r}
maxTfit00_1 <- lm(formula = TMAX ~ year + month, data = NYweath_00 )
summary(maxTfit00_1)  

```

These two extremes and their linear models are plotted in the following figure; it is clear that the multiple regression is a much better model of temperature trends, consistent with the higher r-squared value.  


```{r}
#plot of just July and January

ggplot(NYweath_00, aes(x = year, y = TMAX, color = month)) +
    geom_point() +
    scale_color_manual(values = c("01" = "purple4",
                                   "07" = "red"), na.value = NA) +
    geom_abline(aes(intercept = -11.05508, slope = 0.02539), col = "black", size = 1) + 
    geom_abline(aes(intercept = 34.98295, slope = 0.02539), col = "black", size = 1) +
  
    labs(
        x = "Year",
        y = "Maximum Daily Temperature",
        title = "Maximum Daily Temperature in Central Park") +
    xlab(label = "Year") +
    ylab(label = "Maximum daily temperature") +
    ggtitle(label = "Maximum Daily Temperature in Central Park")
```

To create an even better model, we'd need to use sinusoidal functions that capture the cyclical variation of weather with season; this would take us into scientific data analysis and time series modeling and is a topic for future consideration.  

## Central Park warming trends compared to global trends

We then wanted to use the linear models developed for the Central Park weather data and compare them to the global trends that have been observed over the similar time period. The ground truth rate of temperature change was found on climate.gov which states, "Earth’s temperature has risen by 0.14° Fahrenheit (0.08° Celsius) per decade since 1880, but the rate of warming since 1981 is more than twice that: 0.32° F (0.18° C) per decade." To appropriately compare the Central Park and Global temperature trends over time. New linear models were built for the Central Park data to align to the time periods from climate.gov.  

```{r, results = 'asis'}

weather1880 <- subset(monthly_weather, monthly_weather$year > 1879 & monthly_weather$year < 2022)
yearly_1880 <- subset(yearly_weather, yearly_weather$year > 1879 & yearly_weather$year < 2022)
all_1880 <- subset(NYweath, NYweath$year > 1880)

yr1880_scatter <- ggplot(yearly_1880, aes(x = year, y = TMAX)) + 
  geom_point() +
  labs(x = "Year", y = "Temperature (F)", title = "Yearly Average Maximum Temp")


yr1880_line <- yr1880_scatter +
  stat_smooth(method = "lm",
              formula = y ~ x,
              geom = "smooth",
              col = "black") +
  labs(title = "NYC vs Global Temperature Change since 1880")


yr1880_global <- yr1880_line + 
  geom_abline(aes(intercept = 33.2, slope = 0.014, col = "red")) +
  scale_color_discrete(name = "Locale", labels = c("Global"))

yr1880_global


lm_all1880 <- lm(TMAX ~ year + month, data = all_1880)

```

The first model observed the maximum daily temperatures from 1880-2022, shown in the figure above. Based on what we previously learned, this model fits TMAX vs year and includes month as a categorical regressor to account seasonal variation and improve the fit of the model. This resulted in a model fit with an r-squared value of 0.775 and a slope of 0.3° Fahrenheit per decade, with a p-value that is well below 0.05. The 95% confidence interval for this model's slope is 0.28°-0.32° Fahrenheit per decade. The recorded global rate of temperature change, 0.14° Fahrenheit, is outside of this confidence interval. Thus, we can conclude that the rate of temperature change in Central Park is statistically greater than the global rate of change from 1880-2022. 

The second model observed the maximum daily temperatures for the more recent time period of 1981-2022. This model similarly fits TMAX vs year and includes month as a categorical regressor to account seasonal variation and improve the fit of the model. However, in this model there was no statistically significant correlation between TMAX and year. The model resulted in a good fit with an r-squared value of 0.764 with a slope of 0.1° Fahrenheit per decade - but the p-value of this slope was greater than 0.05. This indicates that more data may be required to make a meaningful model of temperature changes in NYC since 1981.

## Consideration of another New York location  

We wondered whether these trends were true for other locations in the New York City area. To assess this, we found data from another NOAA station at JFK International Airport. Because these data date only as far back as the Airport (which was built in 1948), we focused on 1948 on, computing linear models for both regions for this time window.  

We were surprised to notice that the slope of the Central Park model for 1948 on was lower than that including observations from 1900 on; only 0.014° F (r-squared = 0.771, all p << 0.05) per year compared to 0.025° F (r-squared = 0.773, all p << 0.05). This suggests that average Central Park warming was greater in the first half of the 20th century than in the second half-- which is not what we would intuit based on the understanding that the global rate of warming is increasing.  

We also found a higher warming rate at the JFK airport site, of approximately 0.033° Fahrenheit per year.  

```{r, echo = FALSE}

#Linear models from 1948 on

maxTfit48_1 <- lm(formula = TMAX ~ year + month, data = NYweath_48 )
summary(maxTfit48_1)

# Multiple linear regression for JFK (from 1948 on  
jmaxTfit1 <- lm(formula = TMAX ~ year + month, data = JFKweath_sub )
summary(jmaxTfit1)  

```

To see whether the different warming rates in Central Park post-1900 and post-1948, and at JFK airport are real, we examined the 95 percent confidence intervals associated with each of the three slopes.  

```{r}
warming_compare <- data.frame(col1 = c("Central Park", "Central Park", "JFK"), col2 = c("1900 - 2022", "1948 - 2022", "1948 - 2022"), col3 = c("0.025", "0.014", "0.033"), col4 =  c("[0.023, 0.028]","[0.009, 0.019]","[0.029, 0.038]"))

colnames(warming_compare)[1] <- "Location"
colnames(warming_compare)[2] <- "Time range"
colnames(warming_compare)[3] <- "Slope"
colnames(warming_compare)[4] <- " 95 % Confidence interval"

xkabledply(warming_compare)

```

The confidence intervals for the slope of the three models does not overlap, suggesting that the warming rates are substantially different in the three models. This suggests that:  
1. Temperature trends in Central Park are not strictly linear between 1900 and 2022.  
2. The rate of warming at JFK airport is actually greater than that in Central Park between 1948 and 2022.  

We hypothesize that these trends could be related to rate of development in the areas in question, as concrete can hold more heat than a non-built environment. To test this hypothesis, we could look for other data sets for these locations over the same time period that include some measure of construction.  

## Precipitation trends

As average temperatures on Earth rise, more evaporation occurs which increases overall precipitation. To gauge the effect of this on the local level, we sought to analyze precipitation outliers in our dataset and determine if a significant change has occurred in rainfall over time.  

Outliers are defined as values that lie significantly far from other points in the data. Because there were a lot of days with 0 inches of precipitation which skewed our distribution, we decided to remove them before calculating our outliers.  

```{r prcp outliers, fig.show='hide'}
# extract PRCP outlier rows into df variable
# remove zeros
# group variable by decade, getting sum for each decade
prcp_no_zeros <- NYweath_00 %>%
  filter(PRCP > 0.0 & !is.na(PRCP))

prcp_boxplot <- boxplot(prcp_no_zeros$PRCP, ylab = "Temperature (°F)")

prcp_outliers <- boxplot.stats(prcp_no_zeros$PRCP)$out
prcp_outliers.index <- which(prcp_no_zeros$PRCP %in% c(prcp_outliers))
prcp_outliers_df <- prcp_no_zeros[prcp_outliers.index, ]

prcp_outliers_df.yearly <- prcp_outliers_df %>%
  group_by(year) %>%
  summarize(prcp_total = sum(PRCP, na.rm=T), count = n())

# show top 5 years
top_5_years.prcp_total <- prcp_outliers_df.yearly %>%
  slice_max(order_by = prcp_total, n = 5)

# group into decades and create bar plot
prcp_outliers_df.decades <- prcp_outliers_df %>%
  filter(year < 2020) %>%
  mutate(decade = paste(floor(year / 10) * 10, "s", sep="")) %>%
  group_by(decade) %>%
  summarise(prcp_total = sum(PRCP, na.rm=T), count = n())
```
```{r prcp outlier plots, results='asis'}
prcp_outliers_df.yearly %>%
  ggplot(aes(x=year, y=prcp_total)) +
    geom_line(na.rm=TRUE, alpha=0.7, color="darkgreen") +
    geom_point(na.rm = TRUE, fill="#69b3a2", shape = 21) +
    geom_text_repel(aes(label=year), data=top_5_years.prcp_total) +
    labs(title="Total Precipitation By Year", x="Year", y="Total Yearly Amount (inches)")
```

Looking at the yearly data, we identified a discernible trend of increased variation in the amount of total rainfall within a year starting after 1970. The top 5 years based on total precipitation all reside in the last half century of the collected data.  

```{r prcp decades, results='asis'}
prcp_outliers_df.decades %>%
  ggplot(aes(group=1)) +
  geom_col(aes(x=decade, y=prcp_total), na.rm=TRUE, alpha=0.8, color="black", fill="darkgreen", position="identity") +
  geom_line(aes(x=decade, y=count), stat="identity", color="#69b3a2", size=1) +
  labs(title="Precipitation Outlier Days And Total Precipitation By Decade", x="Decade", y="Total Amount (inches)") +
  scale_y_continuous(sec.axis=sec_axis(~., name="Days with Outliers"))
```

Zooming out, we can see a relationship between the amount of days with precipitation outlier values and the total precipitation amount occurring over the course of a decade. We notice an upwards trend in both values starting in the 1970s, supporting the visual trends analyzed in the yearly totals plot above. This coincides with the patterns of increasing average daily temperature we saw in our prior analysis. Although not part of this report, we could further investigate the correlation between temperature and precipitation to determine if the data signals a statistically significant pattern.  

Another indicator of warming trends, especially for a location such as New York City that experiences all 4 seasons, is the amount of snowfall occurring in a given year. Unfortunately, there was a sizable amount of missing snowfall observations in our dataset which made performing this analysis difficult. What we did have was consistent values on snowfall over the Christmas holiday (Christmas Eve and Christmas Day).  

```{r snowfall, results='asis'}
nyc_weather.christmas_snow <- NYweath_00 %>%
  filter(month == 12, (day == 24 | day == 25)) %>%
  group_by(year) %>%
  summarize(snowfall = sum(SNOW, na.rm = T))

# how many years has there been snow?
with_snow <- nyc_weather.christmas_snow %>%
  filter(snowfall > 0.0)

# yearly plot for years it snowed
with_snow %>%
  ggplot(aes(x=year, y=snowfall)) +
    geom_line(na.rm=TRUE, alpha=0.7, color="steelblue", size=1.25) +
    geom_point(na.rm = TRUE, fill="#00edfa", shape = 21) +
    geom_label_repel(aes(label=year), data=with_snow) +
    labs(title="Years With Snowfall Over Christmas Holiday", x="Year", y="Snowfall (inches)")
```

Since 1900, it has snowed on 24 out of 121 Christmas holidays (~20%). We witnessed a trend of reducing snowfall events over the Christmas holiday beginning around 1980. Between 1980 and 2021, there have been only 4 snowfall events during the Christmas holiday (~10%). If we are able to acquire the necessary data, we can further test the significance of our observations to determine if a statistical correlation exists between snowfall and temperature.  

## Linear models of precipitation trends over time

After seeing the greater variability in precipitation more recently, we plotted total precipitation and total snowfall and fit these variables to linear models to observe the trends over time, shown in the figure below.  

```{r}

# PRCP linear models and plots
yearly_prcp_scatter <- ggplot(yearly_weather_100yr, aes(x = year, y = PRCP_TOT)) + 
  geom_point(color = "darkorchid") +
  labs(x = "Year", y = "Total Precipitation (in)", title = "Total Yearly Precipitation")      


lm_prcp_yr <- lm(PRCP_TOT ~ year, data = yearly_weather_100yr)



yearly_snow_scatter <- ggplot(yearly_weather_100yr, aes(x = year, y = SNOW_TOT)) + 
  geom_point(color = "azure4") +
  labs(x = "Year", y = "Total Snowfall (in)", title = "Total Yearly Snowfall")

lm_snow_yr <- lm(SNOW_TOT ~ year, data = yearly_weather_100yr)
summary(lm_snow_yr)


yr_prcp_scatter_line <- yearly_prcp_scatter+
  stat_smooth(method = "lm",
              formula = y ~ x,
              geom = "smooth",
              color = "black",
              show.legend = F) + 
  labs(title = "Total Yearly Precipitation")


yr_snow_scatter_line <- yearly_snow_scatter+
  stat_smooth(method = "lm",
              formula = y ~ x,
              geom = "smooth",
              color = "black",
              show.legend = F)+
  labs(title = "Total Yearly Snowfall") 


grid.arrange(yr_prcp_scatter_line, yr_snow_scatter_line,
             nrow = 1, 
             top = "Figure C3: Weather Patterns in Central Park, NYC, from 1900-2021")


```

There is no clear trend in the linear model fit in total yearly Central Park precipitation since 1900. The model has a very weak correlation over time, with an r-squared value of 0.09, showing an increase in total precipitation over time at a rate of 0.75 inches per decade, with a p-value less than 0.05. However, given the poor fit to the data, this is likely a result of more higher leverage data points in more recent times that have artificially increased the overall trend. Our earlier observation of increased variability in yearly precipitation over time supports this explanation. 

For total yearly snowfall in Central Park since 1900, there was no statistically significant trend observed in the data. This indicates that there is no change in total yearly snowfall over time. This is an interesting contrast to the rising temperature trends that were observed and warrants future exploration.

## Non-time-dependent relationships between weather variables  

As we move forward with these data, we will further explore relationships between weather variables. For a preview of how this might look, we created a simple correlation plot of all numeric variables for Central Park since 1900.

```{r}
NYweath_num <- subset(NYweath_00, select = c(year, TMAX, TMIN, TAVG, PRCP, SNOW))
str(NYweath_num)
weathcor <- cor(NYweath_num, use = "pairwise.complete.obs")
corrplot::corrplot(weathcor)
cor

```

Preliminarily, it appears that the slight correlation between year and maximum and minimum daily temperatures is reflected here, and that snow has an inverse correlation with the temperature variables. Bringing month back in as a categorical variable might be interesting here. We also note that there seems to be an inverse correlation between average daily temperature and year. However, the plot is only comparing pairwise relationships for which there are data-- and not every day has data for average daily temperature, so these data may not be appropriately representative.  

## Lockdown effects on temperature

The last question our team wanted to address was to understand the changes in weather patterns that may be associated with the COVID-19 lockdown. The COVID-19 lockdown had major social, economic, and political impacts in 2020. The lockdown in New York City in Spring of 2020 was one of the earliest in effect and saw unprecedented traffic and life-pattern changes to those who visited and worked in NYC daily.Our team set out to see if these major changes to the city were noticeable in the weather patterns at the time. 

To do this, the average daily maximum temperatures for spring (considered April and May) and summer (considered June, July and August) were compared using the years leading up to the pandemic and the months following the lockdown order (Figure C4). 


```{r}
# Generating a lock down box plot
covid_spring_summer <- subset(NYweath,
                           year > 2010 &
                           year <= 2020 &
                          (month == "04" |month == "05" | 
                             month == "06" | month == "07" | 
                             month == "08"))
covid_spring_summer_ld <- covid_spring_summer %>%
  add_column(Lockdown = 
               ifelse(.$year < 2020, "Pre-Lockdown", "Post-Lockdown"),
             .after = "year")
covid_spring_summer_ld$Lockdown <- factor(covid_spring_summer_ld$Lockdown, levels = c('Pre-Lockdown', 'Post-Lockdown'))

covid_ld_season <- covid_spring_summer_ld %>%
  add_column(Season = 
               ifelse(.$month == "04" | .$month == "05", 
                      "Spring", "Summer"),
             .after = "year")

covid_boxplot <- ggplot()+
  geom_boxplot(data = covid_ld_season, aes(y = TMAX, x = Season, fill = Lockdown)) +
  labs(title = "Temperature Ranges Pre- and Post- COVID Lockdown")

covid_boxplot



```

```{r}

# performing pre- and post- lock down t test
pre_spring <- subset(NYweath,
                           year > 2010 & year < 2020 &
                           (month == "04" |month == "05"))


pre_summer <- subset(NYweath,
                           year > 2010 & year < 2020 &
                           (month == "06" |month == "07" |
                            month == "08"))


covid_lockdown_spring <- subset(NYweath,
                           year == 2020 &
                           (month == "04" |month == "05"))


covid_lockdown_summer <- subset(NYweath,
                           year == 2020 &
                           (month == "06" |month == "07" |
                            month == "08"))

library(reshape2)

cov_spring_ttest <- t.test(pre_spring$TMAX, covid_lockdown_spring$TMAX)
cov_spring_ttest

cov_summer_ttest <- t.test(pre_summer$TMAX, covid_lockdown_summer$TMAX)
cov_summer_ttest
cov_spring_ttest$conf.int

t.test(pre_spring$TMAX)
t.test(covid_lockdown_spring$TMAX)


```

A t-test was performed to compare the means of the pre-lockdown and post-lockdown maximum daily temperatures (Table C2). For the summer lockdown months, the summer following lockdown appeared to be warmer on average. However, this was not a statistically significant difference in the average maximum temperatures.  

The spring lockdown months showed a statistically significant difference in the means pre- and post- lockdown order. The post-lockdown months were significantly cooler, with a mean spring temperature of 63.5°F, than the years preceding the COVID-19 pandemic, which had a mean spring temperature of 67.3°F.  This is an interesting finding as similar studies found a decrease in the day Land Surface Temperature during COVID-19 lockdown (Parida et al, 2021). The authors attribute the change in temperature to the change in aerosols in the air. The contrast in results warrants further study to explore this trend.

## Conclusion

Our team set out to explore the features of global climate change using a densely populated locale to observe the correlations of human activity and weather conditions. We initially set out to confirm whether the well-documented rise in global temperatures were seen in the Central Park weather data and how those trends compare. To dig into this, we started by analyzing the average temperatures in Central Park during three different eras – the Industrial Revolution, Cold War Era, and Modern Era - between 1900 and 2022. An ANOVA analysis was performed and found there were statistically significant differences in temperature between the three eras. The follow-on analysis showed that the largest temperature difference existed between the Industrial Revolution and Modern Eras.  

Based on these results, we decided to further explore the relationship by generating some linear models of temperature against time. We developed a model for TMAX vs year and included month as a categorical variable to account for the seasonal changes is temperature. The resulting model found a strongly correlated, positive correlation between temperature and year. The model showed a rate of increase in temperate of 0.025° Fahrenheit per year.  

We used this model as a basis to develop new models in order to compare our observed changes to the global documented rate of temperature change. Using new models, we found that since 1880 Central Park has been increasing in temperature at a significantly higher rate than the global trends. However, for a more recent period, we were unable to generate a meaningful model for the data which that more data may be required to make a meaningful model of temperature changes in NYC since 1981.  

The next observation our team wanted to explore was the changes in precipitation patterns over time. For this, we started by analyzing the outliers to determine if there any changes in the variability of precipitation over time.  

Following our outlier analysis, we built linear models for total yearly precipitation and snowfall. For the linear model of precipitation, we observed a very weak positive correlation between precipitation and time. However, this was likely a result of the increased number of outliers in yearly precipitation in more recent years which coincide with our analysis.  

The last observation we looked to explore was the effect of human activity on temperature. The COVID-19 lockdown was an ideal opportunity to observe acute effect of large-scale changes in human activity. We compared the pre- and post- COVID-19 lockdown seasonal temperatures to determine if there were statistical changes associated with the lockdown. We found that the average post-lockdown spring temperatures were significantly lower than the average spring temperatures observed pre-lockdown. This observation differs from documented changes in temperature that occurred due to lock down. This may be a result of the location of Central Park within New York City and warrants additional exploration.  

Overall, our team was able to see clear trends and correlations in the Central Park Weather since 1900. Some of these observations were aligned to recorded patterns while other have some difference from these documented patterns. These discrepancies may be a result of the location of data collection and provides an avenue for future exploration. Additional data would allow us to fully explore the effect of weather from different locations within New York City.  


## References

Parida, B. R., Bar, S., Kaskaoutis, D., Pandey, A. C., Polade, S. D., & Goswami, S. (2021). Impact of COVID-19 induced lockdown on land surface temperature, aerosol, and urban heat in Europe and North America. Sustainable cities and society, 75, 103336. https://doi.org/10.1016/j.scs.2021.103336  

NOAA National Centers for Environmental Information, Monthly Global Climate Report for Annual 2021, published online January 2022, retrieved on November 2, 2022 from https://www.ncei.noaa.gov/access/monitoring/monthly-report/global/202113  

United States Environmental Protection Agency, Climate Change Indicators: U.S. and Global Precipitation, published online August 2022, retrieved on November 2, 2022 from https://www.epa.gov/climate-indicators/climate-change-indicators-us-and-global-precipitation  